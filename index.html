<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OpenMind ‚Äî Open Source AI Assistant</title>
<link href="https://fonts.googleapis.com/css2?family=Syne+Mono&family=Syne:wght@400;600;700;800&family=JetBrains+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
/* ============================================================
   OPENMIND ‚Äî DESIGN SYSTEM
   Aesthetic: Industrial terminal meets soft intelligence
   Palette: Deep navy + electric amber + mint green
   ============================================================ */
:root {
  --void: #05080f;
  --deep: #090d18;
  --panel: #0c1220;
  --surface: #111827;
  --raised: #162030;
  --border: #1e2d45;
  --border2: #243550;
  --amber: #f5a623;
  --amber-dim: #a06a10;
  --mint: #2dd4aa;
  --mint-dim: #1a7a63;
  --blue: #4a9eff;
  --red: #ff4d6d;
  --text: #c8d8ee;
  --text-dim: #556880;
  --text-bright: #eaf2ff;
  --glow-amber: 0 0 20px rgba(245,166,35,0.25);
  --glow-mint: 0 0 20px rgba(45,212,170,0.2);
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

html, body {
  width: 100%; height: 100%;
  background: var(--void);
  color: var(--text);
  font-family: 'Syne', sans-serif;
  overflow: hidden;
}

/* ============================================================
   NOISE OVERLAY
   ============================================================ */
body::before {
  content: '';
  position: fixed; inset: 0; z-index: 9999;
  pointer-events: none;
  opacity: 0.018;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
}

/* ============================================================
   LAYOUT ‚Äî THREE-COLUMN COCKPIT
   ============================================================ */
#app {
  display: grid;
  grid-template-columns: 260px 1fr 280px;
  grid-template-rows: 56px 1fr 48px;
  height: 100vh;
  gap: 0;
}

/* ============================================================
   TOPBAR
   ============================================================ */
#topbar {
  grid-column: 1 / -1;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 20px;
  background: var(--panel);
  border-bottom: 1px solid var(--border);
  position: relative;
  z-index: 100;
}

.topbar-logo {
  display: flex;
  align-items: center;
  gap: 12px;
}

.logo-icon {
  width: 32px; height: 32px;
  position: relative;
}
.logo-icon svg { width: 100%; height: 100%; }

.logo-wordmark {
  font-family: 'Syne', sans-serif;
  font-weight: 800;
  font-size: 1.15rem;
  letter-spacing: 0.5px;
  color: var(--text-bright);
}
.logo-wordmark span { color: var(--amber); }

.logo-badge {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.6rem;
  padding: 2px 7px;
  border: 1px solid var(--amber-dim);
  color: var(--amber);
  letter-spacing: 1.5px;
  border-radius: 2px;
  margin-left: 4px;
}

.topbar-center {
  display: flex;
  align-items: center;
  gap: 4px;
}

.model-pill {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.68rem;
  padding: 5px 14px;
  border: 1px solid var(--border2);
  color: var(--text-dim);
  cursor: pointer;
  letter-spacing: 0.5px;
  transition: all 0.15s;
  border-radius: 2px;
  background: var(--surface);
}
.model-pill.active {
  border-color: var(--mint);
  color: var(--mint);
  background: rgba(45,212,170,0.06);
}
.model-pill:hover:not(.active) {
  border-color: var(--border2);
  color: var(--text);
}

.topbar-right {
  display: flex;
  align-items: center;
  gap: 10px;
}

.status-indicator {
  display: flex;
  align-items: center;
  gap: 6px;
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.65rem;
  color: var(--text-dim);
  letter-spacing: 1px;
}
.status-dot {
  width: 7px; height: 7px;
  border-radius: 50%;
  background: var(--mint);
  box-shadow: 0 0 8px var(--mint);
  animation: pulse-dot 2s ease-in-out infinite;
}
@keyframes pulse-dot {
  0%,100% { opacity: 1; box-shadow: 0 0 8px var(--mint); }
  50% { opacity: 0.5; box-shadow: 0 0 2px var(--mint); }
}
.status-dot.thinking { background: var(--amber); box-shadow: 0 0 8px var(--amber); animation: pulse-think 0.6s ease-in-out infinite; }
@keyframes pulse-think { 0%,100% { transform: scale(1); } 50% { transform: scale(1.4); } }

.icon-btn {
  width: 32px; height: 32px;
  display: flex; align-items: center; justify-content: center;
  border: 1px solid var(--border);
  background: transparent;
  color: var(--text-dim);
  cursor: pointer;
  font-size: 0.85rem;
  transition: all 0.15s;
  border-radius: 3px;
}
.icon-btn:hover { border-color: var(--border2); color: var(--text); background: var(--raised); }
.icon-btn.danger:hover { border-color: var(--red); color: var(--red); }

/* ============================================================
   LEFT SIDEBAR ‚Äî SESSIONS & PLUGINS
   ============================================================ */
#sidebar-left {
  background: var(--deep);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.sidebar-section {
  padding: 16px 16px 8px;
  border-bottom: 1px solid var(--border);
}

.sidebar-label {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.6rem;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--text-dim);
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 8px;
}
.sidebar-label::before {
  content: '//';
  color: var(--amber);
  font-size: 0.55rem;
}

.new-chat-btn {
  width: 100%;
  padding: 9px 14px;
  border: 1px dashed var(--border2);
  background: transparent;
  color: var(--text-dim);
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.68rem;
  letter-spacing: 1px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  transition: all 0.15s;
  border-radius: 2px;
}
.new-chat-btn:hover {
  border-color: var(--amber);
  color: var(--amber);
  background: rgba(245,166,35,0.04);
}

#sessions-list {
  flex: 1;
  overflow-y: auto;
  padding: 8px;
}
#sessions-list::-webkit-scrollbar { width: 3px; }
#sessions-list::-webkit-scrollbar-track { background: transparent; }
#sessions-list::-webkit-scrollbar-thumb { background: var(--border); }

.session-item {
  padding: 10px 12px;
  cursor: pointer;
  border-radius: 3px;
  margin-bottom: 2px;
  transition: all 0.12s;
  border: 1px solid transparent;
  position: relative;
}
.session-item:hover { background: var(--raised); border-color: var(--border); }
.session-item.active { background: var(--raised); border-color: var(--border2); }
.session-item.active::before {
  content: '';
  position: absolute;
  left: 0; top: 50%;
  transform: translateY(-50%);
  width: 3px; height: 60%;
  background: var(--amber);
  border-radius: 0 2px 2px 0;
}
.session-title {
  font-size: 0.78rem;
  color: var(--text);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  font-weight: 600;
  margin-bottom: 3px;
}
.session-meta {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.6rem;
  color: var(--text-dim);
}

/* PLUGINS */
#plugins-section {
  padding: 16px;
  overflow-y: auto;
  max-height: 220px;
}
#plugins-section::-webkit-scrollbar { width: 3px; }
#plugins-section::-webkit-scrollbar-thumb { background: var(--border); }

.plugin-card {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px 10px;
  border: 1px solid var(--border);
  margin-bottom: 6px;
  border-radius: 3px;
  cursor: pointer;
  transition: all 0.15s;
  background: var(--panel);
}
.plugin-card:hover { border-color: var(--border2); background: var(--raised); }
.plugin-card.enabled { border-color: var(--mint-dim); }
.plugin-icon { font-size: 1rem; flex-shrink: 0; width: 22px; text-align: center; }
.plugin-info { flex: 1; min-width: 0; }
.plugin-name {
  font-size: 0.72rem;
  color: var(--text);
  font-weight: 600;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.plugin-desc {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.58rem;
  color: var(--text-dim);
  margin-top: 1px;
}
.plugin-toggle {
  width: 28px; height: 15px;
  border-radius: 8px;
  background: var(--border);
  position: relative;
  cursor: pointer;
  transition: background 0.2s;
  flex-shrink: 0;
}
.plugin-toggle.on { background: var(--mint-dim); }
.plugin-toggle::after {
  content: '';
  position: absolute;
  top: 2px; left: 2px;
  width: 11px; height: 11px;
  border-radius: 50%;
  background: var(--text-dim);
  transition: all 0.2s;
}
.plugin-toggle.on::after { left: 15px; background: var(--mint); }

/* ============================================================
   MAIN CHAT AREA
   ============================================================ */
#chat-area {
  display: flex;
  flex-direction: column;
  background: var(--void);
  position: relative;
  overflow: hidden;
}

/* Grid background for chat */
#chat-area::before {
  content: '';
  position: absolute; inset: 0;
  background-image:
    linear-gradient(rgba(45,212,170,0.03) 1px, transparent 1px),
    linear-gradient(90deg, rgba(45,212,170,0.03) 1px, transparent 1px);
  background-size: 48px 48px;
  pointer-events: none;
  mask-image: radial-gradient(ellipse 80% 80% at 50% 50%, black 40%, transparent 100%);
}

#messages {
  flex: 1;
  overflow-y: auto;
  padding: 28px 32px;
  display: flex;
  flex-direction: column;
  gap: 24px;
  position: relative;
  z-index: 1;
}
#messages::-webkit-scrollbar { width: 4px; }
#messages::-webkit-scrollbar-track { background: transparent; }
#messages::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

/* WELCOME SCREEN */
#welcome {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100%;
  text-align: center;
  gap: 24px;
  padding: 40px;
}

.welcome-orb {
  width: 80px; height: 80px;
  position: relative;
}
.orb-ring {
  position: absolute; inset: 0;
  border: 1.5px solid rgba(245,166,35,0.3);
  border-radius: 50%;
  animation: orb-spin 8s linear infinite;
}
.orb-ring:nth-child(2) {
  inset: 8px;
  border-color: rgba(45,212,170,0.3);
  animation-duration: 5s;
  animation-direction: reverse;
}
.orb-core {
  position: absolute;
  inset: 20px;
  background: radial-gradient(circle, rgba(245,166,35,0.5) 0%, rgba(45,212,170,0.3) 60%, transparent 100%);
  border-radius: 50%;
  animation: orb-pulse 3s ease-in-out infinite;
}
@keyframes orb-spin { to { transform: rotate(360deg); } }
@keyframes orb-pulse {
  0%,100% { transform: scale(0.9); opacity: 0.7; }
  50% { transform: scale(1.1); opacity: 1; }
}

.welcome-title {
  font-size: 1.6rem;
  font-weight: 800;
  color: var(--text-bright);
  letter-spacing: -0.5px;
}
.welcome-title span { color: var(--amber); }

.welcome-sub {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.75rem;
  color: var(--text-dim);
  letter-spacing: 1px;
  max-width: 400px;
  line-height: 1.8;
}

.suggestions {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
  width: 100%;
  max-width: 480px;
  margin-top: 8px;
}
.suggestion {
  padding: 12px 16px;
  border: 1px solid var(--border);
  background: var(--panel);
  cursor: pointer;
  text-align: left;
  transition: all 0.15s;
  border-radius: 3px;
}
.suggestion:hover { border-color: var(--amber); background: rgba(245,166,35,0.05); transform: translateY(-1px); }
.sug-icon { font-size: 1rem; margin-bottom: 6px; display: block; }
.sug-title { font-size: 0.78rem; color: var(--text); font-weight: 600; }
.sug-desc { font-family: 'JetBrains Mono', monospace; font-size: 0.6rem; color: var(--text-dim); margin-top: 3px; }

/* MESSAGE BUBBLES */
.message {
  display: flex;
  gap: 14px;
  animation: msg-in 0.3s ease-out;
}
@keyframes msg-in {
  from { opacity: 0; transform: translateY(8px); }
  to { opacity: 1; transform: translateY(0); }
}

.message.user { flex-direction: row-reverse; }

.msg-avatar {
  width: 32px; height: 32px;
  border-radius: 3px;
  flex-shrink: 0;
  display: flex; align-items: center; justify-content: center;
  font-size: 0.75rem;
  font-weight: 700;
  font-family: 'JetBrains Mono', monospace;
}
.msg-avatar.ai { background: rgba(245,166,35,0.12); border: 1px solid var(--amber-dim); color: var(--amber); }
.msg-avatar.user-av { background: rgba(45,212,170,0.1); border: 1px solid var(--mint-dim); color: var(--mint); }

.msg-content {
  flex: 1;
  max-width: 75%;
  min-width: 0;
}

.msg-meta {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 6px;
}
.message.user .msg-meta { flex-direction: row-reverse; }

.msg-role {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.62rem;
  color: var(--text-dim);
  letter-spacing: 1px;
  text-transform: uppercase;
}
.msg-time {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.58rem;
  color: var(--text-dim);
  opacity: 0.5;
}
.msg-model-tag {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.55rem;
  padding: 1px 6px;
  border: 1px solid var(--border);
  color: var(--text-dim);
  border-radius: 2px;
}

.msg-bubble {
  padding: 14px 18px;
  border-radius: 4px;
  font-size: 0.88rem;
  line-height: 1.7;
  position: relative;
}
.message.ai .msg-bubble {
  background: var(--panel);
  border: 1px solid var(--border);
  border-top-left-radius: 0;
  color: var(--text);
}
.message.user .msg-bubble {
  background: rgba(245,166,35,0.07);
  border: 1px solid rgba(245,166,35,0.2);
  border-top-right-radius: 0;
  color: var(--text-bright);
  text-align: right;
}

/* Code blocks inside messages */
.msg-bubble code {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.8rem;
  background: var(--raised);
  padding: 1px 5px;
  border-radius: 2px;
  color: var(--mint);
}
.msg-bubble pre {
  background: var(--raised);
  border: 1px solid var(--border);
  border-radius: 3px;
  padding: 14px 16px;
  margin: 10px 0;
  overflow-x: auto;
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.78rem;
  line-height: 1.6;
  color: var(--mint);
  position: relative;
}
.msg-bubble pre::before {
  content: 'CODE';
  position: absolute;
  top: 6px; right: 10px;
  font-size: 0.55rem;
  letter-spacing: 2px;
  color: var(--text-dim);
}

/* Thinking indicator */
.thinking-msg .msg-bubble {
  display: flex;
  align-items: center;
  gap: 12px;
  color: var(--text-dim);
  font-style: italic;
  font-size: 0.82rem;
}
.think-dots {
  display: flex; gap: 4px;
}
.think-dots span {
  width: 5px; height: 5px;
  border-radius: 50%;
  background: var(--amber);
  animation: think-bounce 1.2s ease-in-out infinite;
}
.think-dots span:nth-child(2) { animation-delay: 0.2s; }
.think-dots span:nth-child(3) { animation-delay: 0.4s; }
@keyframes think-bounce {
  0%,60%,100% { transform: translateY(0); opacity: 0.4; }
  30% { transform: translateY(-5px); opacity: 1; }
}

/* Message action bar */
.msg-actions {
  display: flex;
  gap: 4px;
  margin-top: 6px;
  opacity: 0;
  transition: opacity 0.15s;
}
.message:hover .msg-actions { opacity: 1; }
.message.user .msg-actions { justify-content: flex-end; }
.msg-action {
  padding: 3px 8px;
  border: 1px solid var(--border);
  background: transparent;
  color: var(--text-dim);
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.58rem;
  letter-spacing: 0.5px;
  cursor: pointer;
  border-radius: 2px;
  transition: all 0.12s;
}
.msg-action:hover { border-color: var(--amber); color: var(--amber); background: rgba(245,166,35,0.05); }

/* ============================================================
   INPUT AREA
   ============================================================ */
#input-area {
  padding: 16px 24px 20px;
  border-top: 1px solid var(--border);
  background: var(--deep);
  position: relative;
  z-index: 10;
}

.input-wrapper {
  display: flex;
  gap: 10px;
  align-items: flex-end;
  background: var(--panel);
  border: 1px solid var(--border2);
  border-radius: 4px;
  padding: 10px 14px;
  transition: border-color 0.15s;
}
.input-wrapper:focus-within {
  border-color: var(--amber);
  box-shadow: 0 0 0 1px rgba(245,166,35,0.1);
}

.attach-btn {
  flex-shrink: 0;
  width: 30px; height: 30px;
  display: flex; align-items: center; justify-content: center;
  color: var(--text-dim);
  cursor: pointer;
  font-size: 1rem;
  border-radius: 3px;
  transition: all 0.12s;
  border: none;
  background: none;
  align-self: flex-end;
}
.attach-btn:hover { color: var(--amber); }

#msg-input {
  flex: 1;
  background: transparent;
  border: none;
  outline: none;
  color: var(--text-bright);
  font-family: 'Syne', sans-serif;
  font-size: 0.9rem;
  line-height: 1.6;
  resize: none;
  max-height: 160px;
  min-height: 24px;
  overflow-y: auto;
  padding: 3px 0;
}
#msg-input::placeholder { color: var(--text-dim); }
#msg-input::-webkit-scrollbar { width: 2px; }
#msg-input::-webkit-scrollbar-thumb { background: var(--border); }

.send-btn {
  flex-shrink: 0;
  width: 36px; height: 36px;
  display: flex; align-items: center; justify-content: center;
  background: var(--amber);
  color: var(--void);
  border: none;
  border-radius: 3px;
  cursor: pointer;
  font-size: 0.9rem;
  transition: all 0.15s;
  align-self: flex-end;
}
.send-btn:hover { background: #ffbe45; transform: translateY(-1px); box-shadow: var(--glow-amber); }
.send-btn:disabled { background: var(--border); color: var(--text-dim); cursor: not-allowed; transform: none; box-shadow: none; }

.input-meta {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 8px;
  padding: 0 2px;
}
.input-hint {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.58rem;
  color: var(--text-dim);
  letter-spacing: 0.5px;
}
.input-hint kbd {
  padding: 1px 5px;
  background: var(--raised);
  border: 1px solid var(--border);
  border-radius: 2px;
  font-size: 0.55rem;
  color: var(--text-dim);
}
.char-count {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.58rem;
  color: var(--text-dim);
}

/* ============================================================
   RIGHT SIDEBAR ‚Äî CONTEXT & MEMORY
   ============================================================ */
#sidebar-right {
  background: var(--deep);
  border-left: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.rsb-tab-bar {
  display: flex;
  border-bottom: 1px solid var(--border);
}
.rsb-tab {
  flex: 1;
  padding: 10px 8px;
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.62rem;
  letter-spacing: 1px;
  text-transform: uppercase;
  color: var(--text-dim);
  cursor: pointer;
  text-align: center;
  border-bottom: 2px solid transparent;
  transition: all 0.15s;
  background: none;
  border: none;
  border-bottom: 2px solid transparent;
}
.rsb-tab.active { color: var(--amber); border-bottom-color: var(--amber); }
.rsb-tab:hover:not(.active) { color: var(--text); }

.rsb-panel { display: none; flex: 1; flex-direction: column; overflow: hidden; }
.rsb-panel.active { display: flex; }

.rsb-content {
  flex: 1;
  padding: 16px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 12px;
}
.rsb-content::-webkit-scrollbar { width: 3px; }
.rsb-content::-webkit-scrollbar-thumb { background: var(--border); }

/* System prompt editor */
.sys-prompt-area {
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 3px;
  padding: 12px;
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.72rem;
  color: var(--text);
  line-height: 1.7;
  min-height: 120px;
  width: 100%;
  resize: vertical;
  outline: none;
  transition: border-color 0.15s;
}
.sys-prompt-area:focus { border-color: var(--amber); }

/* Memory items */
.memory-item {
  padding: 10px 12px;
  border: 1px solid var(--border);
  background: var(--panel);
  border-radius: 3px;
  font-size: 0.75rem;
  color: var(--text);
  line-height: 1.6;
  position: relative;
  transition: all 0.12s;
}
.memory-item:hover { border-color: var(--border2); }
.memory-item::before {
  content: '‚óà';
  color: var(--mint);
  margin-right: 7px;
  font-size: 0.65rem;
}
.memory-delete {
  position: absolute;
  top: 6px; right: 8px;
  font-size: 0.7rem;
  color: var(--text-dim);
  cursor: pointer;
  opacity: 0;
  transition: opacity 0.12s;
}
.memory-item:hover .memory-delete { opacity: 1; }
.memory-delete:hover { color: var(--red); }

/* Settings sliders */
.setting-row {
  display: flex;
  flex-direction: column;
  gap: 6px;
  padding: 10px 0;
  border-bottom: 1px solid var(--border);
}
.setting-row:last-child { border-bottom: none; }
.setting-label {
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.setting-name {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.68rem;
  color: var(--text);
  letter-spacing: 0.5px;
}
.setting-value {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.68rem;
  color: var(--amber);
}
.setting-slider {
  -webkit-appearance: none;
  width: 100%;
  height: 3px;
  background: var(--border2);
  border-radius: 2px;
  outline: none;
}
.setting-slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 13px; height: 13px;
  border-radius: 50%;
  background: var(--amber);
  cursor: pointer;
  box-shadow: 0 0 6px rgba(245,166,35,0.4);
}

.setting-select {
  width: 100%;
  padding: 6px 10px;
  background: var(--panel);
  border: 1px solid var(--border);
  color: var(--text);
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.68rem;
  border-radius: 2px;
  outline: none;
  cursor: pointer;
}
.setting-select:focus { border-color: var(--amber); }

/* Stats panel */
.stats-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
}
.stat-box {
  background: var(--panel);
  border: 1px solid var(--border);
  padding: 12px;
  border-radius: 3px;
  text-align: center;
}
.stat-val {
  font-family: 'JetBrains Mono', monospace;
  font-size: 1.2rem;
  font-weight: 500;
  color: var(--amber);
  display: block;
}
.stat-lbl {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.58rem;
  color: var(--text-dim);
  letter-spacing: 1px;
  text-transform: uppercase;
  margin-top: 3px;
  display: block;
}

/* ============================================================
   STATUSBAR
   ============================================================ */
#statusbar {
  grid-column: 1 / -1;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 16px;
  background: var(--panel);
  border-top: 1px solid var(--border);
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.58rem;
  color: var(--text-dim);
  letter-spacing: 0.5px;
}
.status-left, .status-right { display: flex; align-items: center; gap: 16px; }
.sb-item { display: flex; align-items: center; gap: 5px; }
.sb-accent { color: var(--mint); }
.sb-warn { color: var(--amber); }

/* ============================================================
   API KEY MODAL
   ============================================================ */
#api-modal {
  position: fixed; inset: 0;
  background: rgba(5,8,15,0.92);
  backdrop-filter: blur(8px);
  z-index: 1000;
  display: flex; align-items: center; justify-content: center;
}
#api-modal.hidden { display: none; }

.modal-box {
  background: var(--surface);
  border: 1px solid var(--border2);
  padding: 40px;
  width: 480px;
  max-width: 90vw;
  box-shadow: 0 40px 80px rgba(0,0,0,0.6);
}
.modal-header {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 28px;
}
.modal-icon {
  width: 40px; height: 40px;
  background: rgba(245,166,35,0.1);
  border: 1px solid var(--amber-dim);
  display: flex; align-items: center; justify-content: center;
  font-size: 1.2rem;
  border-radius: 4px;
}
.modal-title {
  font-size: 1.1rem;
  font-weight: 800;
  color: var(--text-bright);
}
.modal-sub {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.65rem;
  color: var(--text-dim);
  margin-top: 2px;
  letter-spacing: 0.5px;
}
.modal-desc {
  font-size: 0.82rem;
  color: var(--text-dim);
  line-height: 1.7;
  margin-bottom: 24px;
}
.modal-desc a { color: var(--amber); text-decoration: none; }
.modal-desc a:hover { text-decoration: underline; }

.field-label {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.65rem;
  letter-spacing: 1.5px;
  text-transform: uppercase;
  color: var(--text-dim);
  margin-bottom: 8px;
}
.field-input {
  width: 100%;
  padding: 11px 14px;
  background: var(--panel);
  border: 1px solid var(--border2);
  color: var(--text-bright);
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.82rem;
  outline: none;
  border-radius: 3px;
  transition: border-color 0.15s;
  letter-spacing: 0.5px;
}
.field-input:focus { border-color: var(--amber); box-shadow: 0 0 0 1px rgba(245,166,35,0.1); }

.modal-actions {
  display: flex;
  gap: 10px;
  margin-top: 24px;
}
.btn-primary {
  flex: 1;
  padding: 12px;
  background: var(--amber);
  color: var(--void);
  border: none;
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.78rem;
  font-weight: 700;
  letter-spacing: 1.5px;
  text-transform: uppercase;
  cursor: pointer;
  border-radius: 3px;
  transition: all 0.15s;
}
.btn-primary:hover { background: #ffbe45; box-shadow: var(--glow-amber); }

.btn-secondary {
  padding: 12px 20px;
  background: transparent;
  color: var(--text-dim);
  border: 1px solid var(--border);
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.78rem;
  letter-spacing: 1px;
  cursor: pointer;
  border-radius: 3px;
  transition: all 0.15s;
}
.btn-secondary:hover { border-color: var(--border2); color: var(--text); }

.modal-note {
  margin-top: 16px;
  padding: 10px 14px;
  background: rgba(45,212,170,0.05);
  border: 1px solid var(--mint-dim);
  border-radius: 3px;
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.62rem;
  color: var(--mint);
  line-height: 1.6;
}

/* ============================================================
   TOAST
   ============================================================ */
#toast-container {
  position: fixed;
  bottom: 64px; right: 20px;
  z-index: 2000;
  display: flex; flex-direction: column; gap: 8px;
  pointer-events: none;
}
.toast {
  padding: 10px 16px;
  background: var(--raised);
  border: 1px solid var(--border2);
  border-radius: 3px;
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.7rem;
  color: var(--text);
  animation: toast-in 0.2s ease-out;
  max-width: 280px;
  letter-spacing: 0.3px;
}
.toast.success { border-left: 3px solid var(--mint); }
.toast.error { border-left: 3px solid var(--red); }
.toast.info { border-left: 3px solid var(--amber); }
@keyframes toast-in { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }

/* ============================================================
   SCROLLBAR GLOBAL
   ============================================================ */
::-webkit-scrollbar { width: 4px; height: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

/* ============================================================
   RESPONSIVE HANDLING
   ============================================================ */
@media (max-width: 1024px) {
  #app { grid-template-columns: 220px 1fr; }
  #sidebar-right { display: none; }
}
@media (max-width: 700px) {
  #app { grid-template-columns: 1fr; }
  #sidebar-left { display: none; }
}
</style>
</head>
<body>

<!-- API KEY MODAL -->
<div id="api-modal">
  <div class="modal-box">
    <div class="modal-header">
      <div class="modal-icon">üîë</div>
      <div>
        <div class="modal-title">Connect to Claude API</div>
        <div class="modal-sub">OPENMIND v1.0 ‚Äî SETUP REQUIRED</div>
      </div>
    </div>
    <p class="modal-desc">
      OpenMind connects directly to the <strong style="color:var(--text)">Anthropic Claude API</strong> from your browser.
      Your key is stored locally and never leaves your device.<br><br>
      Get your free API key at <a href="https://console.anthropic.com" target="_blank">console.anthropic.com ‚Üí</a>
    </p>
    <div class="field-label">Anthropic API Key</div>
    <input class="field-input" id="api-key-input" type="password" placeholder="sk-ant-..." autocomplete="off" spellcheck="false">
    <div class="modal-actions">
      <button class="btn-primary" onclick="saveApiKey()">Connect & Launch</button>
      <button class="btn-secondary" onclick="skipApiKey()">Demo Mode</button>
    </div>
    <div class="modal-note">
      üîí Your API key is stored only in this browser session (sessionStorage). It is never transmitted to any server other than Anthropic's official API endpoint.
    </div>
  </div>
</div>

<!-- TOAST CONTAINER -->
<div id="toast-container"></div>

<!-- MAIN APP -->
<div id="app">

  <!-- TOPBAR -->
  <header id="topbar">
    <div class="topbar-logo">
      <div class="logo-icon">
        <svg viewBox="0 0 32 32" fill="none">
          <circle cx="16" cy="16" r="14" stroke="#f5a623" stroke-width="1.5" opacity="0.4"/>
          <circle cx="16" cy="16" r="9" stroke="#2dd4aa" stroke-width="1" opacity="0.5"/>
          <circle cx="16" cy="16" r="4" fill="#f5a623" opacity="0.8"/>
          <line x1="16" y1="2" x2="16" y2="8" stroke="#f5a623" stroke-width="1.5" opacity="0.6"/>
          <line x1="16" y1="24" x2="16" y2="30" stroke="#f5a623" stroke-width="1.5" opacity="0.6"/>
          <line x1="2" y1="16" x2="8" y2="16" stroke="#f5a623" stroke-width="1.5" opacity="0.6"/>
          <line x1="24" y1="16" x2="30" y2="16" stroke="#f5a623" stroke-width="1.5" opacity="0.6"/>
        </svg>
      </div>
      <div class="logo-wordmark">Open<span>Mind</span></div>
      <span class="logo-badge">v1.0 OSS</span>
    </div>

    <div class="topbar-center">
      <button class="model-pill active" onclick="setModel('claude-sonnet-4-5-20250929', this)" id="pill-sonnet">Sonnet 4.5</button>
      <button class="model-pill" onclick="setModel('claude-haiku-4-5-20251001', this)" id="pill-haiku">Haiku 4.5</button>
      <button class="model-pill" onclick="setModel('claude-opus-4-5-20251101', this)" id="pill-opus">Opus 4.5</button>
    </div>

    <div class="topbar-right">
      <div class="status-indicator">
        <div class="status-dot" id="status-dot"></div>
        <span id="status-text">READY</span>
      </div>
      <button class="icon-btn" onclick="showApiModal()" title="API Key">üîë</button>
      <button class="icon-btn" onclick="exportChat()" title="Export Chat">üíæ</button>
      <button class="icon-btn danger" onclick="clearAllSessions()" title="Clear All">üóë</button>
    </div>
  </header>

  <!-- LEFT SIDEBAR -->
  <aside id="sidebar-left">
    <div class="sidebar-section">
      <div class="sidebar-label">Sessions</div>
      <button class="new-chat-btn" onclick="newSession()">
        <span>Ôºã</span> NEW CONVERSATION
      </button>
    </div>
    <div id="sessions-list"></div>

    <div style="border-top:1px solid var(--border)">
      <div class="sidebar-section">
        <div class="sidebar-label">Plugins</div>
      </div>
      <div id="plugins-section">
        <!-- Plugins rendered by JS -->
      </div>
    </div>
  </aside>

  <!-- MAIN CHAT -->
  <main id="chat-area">
    <div id="messages">
      <div id="welcome">
        <div class="welcome-orb">
          <div class="orb-ring"></div>
          <div class="orb-ring"></div>
          <div class="orb-core"></div>
        </div>
        <div>
          <div class="welcome-title">Welcome to <span>OpenMind</span></div>
          <div class="welcome-sub" style="margin:8px auto 0">Open-source AI assistant powered by Claude. Your API key stays local. Your data stays yours.</div>
        </div>
        <div class="suggestions">
          <div class="suggestion" onclick="useSuggestion('Write me a Python script to scrape headlines from Hacker News and summarize them')">
            <span class="sug-icon">üêç</span>
            <div class="sug-title">Code Generation</div>
            <div class="sug-desc">Write Python scripts & more</div>
          </div>
          <div class="suggestion" onclick="useSuggestion('Explain how transformer neural networks work in simple terms with analogies')">
            <span class="sug-icon">üß†</span>
            <div class="sug-title">Deep Explanation</div>
            <div class="sug-desc">Break down complex topics</div>
          </div>
          <div class="suggestion" onclick="useSuggestion('Help me debug this React component that keeps re-rendering infinitely')">
            <span class="sug-icon">üîß</span>
            <div class="sug-title">Debug & Fix</div>
            <div class="sug-desc">Solve code & logic issues</div>
          </div>
          <div class="suggestion" onclick="useSuggestion('Draft a professional email declining a meeting request while suggesting an alternative time')">
            <span class="sug-icon">‚úçÔ∏è</span>
            <div class="sug-title">Writing Assistant</div>
            <div class="sug-desc">Emails, docs & creative work</div>
          </div>
        </div>
      </div>
    </div>

    <div id="input-area">
      <div class="input-wrapper">
        <button class="attach-btn" onclick="openFileMenu()" title="Attach file">üìé</button>
        <textarea id="msg-input" placeholder="Ask OpenMind anything‚Ä¶" rows="1" onkeydown="handleKey(event)" oninput="autoResize(this); updateCharCount()"></textarea>
        <button class="send-btn" id="send-btn" onclick="sendMessage()">‚û§</button>
      </div>
      <div class="input-meta">
        <div class="input-hint"><kbd>Enter</kbd> to send ¬∑ <kbd>Shift+Enter</kbd> for newline ¬∑ <kbd>Ctrl+K</kbd> new chat</div>
        <div class="char-count" id="char-count">0 chars</div>
      </div>
    </div>
  </main>

  <!-- RIGHT SIDEBAR -->
  <aside id="sidebar-right">
    <div class="rsb-tab-bar">
      <button class="rsb-tab active" onclick="switchRsbTab('context', this)">Context</button>
      <button class="rsb-tab" onclick="switchRsbTab('memory', this)">Memory</button>
      <button class="rsb-tab" onclick="switchRsbTab('settings', this)">Config</button>
      <button class="rsb-tab" onclick="switchRsbTab('stats', this)">Stats</button>
    </div>

    <!-- CONTEXT TAB -->
    <div class="rsb-panel active" id="rsb-context">
      <div class="rsb-content">
        <div class="sidebar-label">System Prompt</div>
        <textarea class="sys-prompt-area" id="sys-prompt" rows="6" placeholder="You are a helpful AI assistant..." oninput="saveSystemPrompt()">You are OpenMind, a highly capable open-source AI assistant. You are thoughtful, precise, and help users with code, analysis, writing, and reasoning. When writing code, use markdown code blocks. Be concise but thorough.</textarea>

        <div class="sidebar-label" style="margin-top:8px">Active Context</div>
        <div id="context-files" style="display:flex;flex-direction:column;gap:6px">
          <div style="font-family:'JetBrains Mono',monospace;font-size:0.62rem;color:var(--text-dim);padding:10px;background:var(--panel);border:1px dashed var(--border);border-radius:3px;text-align:center">
            No files attached<br>
            <span style="opacity:0.6">Click üìé in the input to attach</span>
          </div>
        </div>

        <div class="sidebar-label" style="margin-top:8px">Conversation Info</div>
        <div id="conv-info" style="background:var(--panel);border:1px solid var(--border);padding:12px;border-radius:3px">
          <div style="font-family:'JetBrains Mono',monospace;font-size:0.65rem;color:var(--text-dim);line-height:1.9">
            <div>Messages: <span id="info-msgs" style="color:var(--text)">0</span></div>
            <div>Est. tokens: <span id="info-tokens" style="color:var(--text)">0</span></div>
            <div>Model: <span id="info-model" style="color:var(--amber)">claude-sonnet-4-5</span></div>
            <div>Session: <span id="info-session" style="color:var(--mint)">‚Äî</span></div>
          </div>
        </div>
      </div>
    </div>

    <!-- MEMORY TAB -->
    <div class="rsb-panel" id="rsb-memory">
      <div class="rsb-content" id="memory-list">
        <!-- Memory items rendered by JS -->
      </div>
      <div style="padding:12px;border-top:1px solid var(--border)">
        <div style="display:flex;gap:6px">
          <input id="mem-input" class="field-input" style="font-size:0.7rem;padding:8px 10px" placeholder="Add a memory‚Ä¶" onkeydown="if(event.key==='Enter')addMemory()">
          <button onclick="addMemory()" style="padding:8px 12px;background:var(--amber);color:var(--void);border:none;cursor:pointer;border-radius:3px;font-size:0.75rem;font-weight:700">+</button>
        </div>
      </div>
    </div>

    <!-- SETTINGS TAB -->
    <div class="rsb-panel" id="rsb-settings">
      <div class="rsb-content">
        <div class="setting-row">
          <div class="setting-label">
            <span class="setting-name">Temperature</span>
            <span class="setting-value" id="temp-val">0.7</span>
          </div>
          <input type="range" class="setting-slider" min="0" max="1" step="0.05" value="0.7" oninput="updateSetting('temperature', this.value, 'temp-val')">
        </div>
        <div class="setting-row">
          <div class="setting-label">
            <span class="setting-name">Max Tokens</span>
            <span class="setting-value" id="maxtok-val">2048</span>
          </div>
          <input type="range" class="setting-slider" min="256" max="8192" step="256" value="2048" oninput="updateSetting('maxTokens', this.value, 'maxtok-val')">
        </div>
        <div class="setting-row">
          <div class="setting-label">
            <span class="setting-name">Top P</span>
            <span class="setting-value" id="topp-val">0.95</span>
          </div>
          <input type="range" class="setting-slider" min="0.1" max="1" step="0.05" value="0.95" oninput="updateSetting('topP', this.value, 'topp-val')">
        </div>
        <div class="setting-row">
          <div class="setting-label">
            <span class="setting-name">Response Format</span>
          </div>
          <select class="setting-select" id="resp-format" onchange="config.responseFormat = this.value">
            <option value="markdown">Markdown</option>
            <option value="plain">Plain Text</option>
            <option value="json">JSON Mode</option>
          </select>
        </div>
        <div class="setting-row">
          <div class="setting-label">
            <span class="setting-name">Stream Responses</span>
            <span class="setting-value" id="stream-val">ON</span>
          </div>
          <input type="range" class="setting-slider" min="0" max="1" step="1" value="1" oninput="config.streaming = !!parseInt(this.value); document.getElementById('stream-val').textContent = config.streaming ? 'ON' : 'OFF'">
        </div>
        <div class="setting-row">
          <div class="setting-label">
            <span class="setting-name">Auto-Save Sessions</span>
            <span class="setting-value" id="autosave-val">ON</span>
          </div>
          <input type="range" class="setting-slider" min="0" max="1" step="1" value="1" oninput="config.autoSave = !!parseInt(this.value); document.getElementById('autosave-val').textContent = config.autoSave ? 'ON' : 'OFF'">
        </div>
      </div>
    </div>

    <!-- STATS TAB -->
    <div class="rsb-panel" id="rsb-stats">
      <div class="rsb-content">
        <div class="stats-grid">
          <div class="stat-box">
            <span class="stat-val" id="stat-msgs">0</span>
            <span class="stat-lbl">Messages</span>
          </div>
          <div class="stat-box">
            <span class="stat-val" id="stat-sessions">0</span>
            <span class="stat-lbl">Sessions</span>
          </div>
          <div class="stat-box">
            <span class="stat-val" id="stat-tokens">0</span>
            <span class="stat-lbl">Est. Tokens</span>
          </div>
          <div class="stat-box">
            <span class="stat-val" id="stat-calls">0</span>
            <span class="stat-lbl">API Calls</span>
          </div>
        </div>

        <div class="sidebar-label" style="margin-top:16px">Token Usage (Session)</div>
        <div id="token-chart" style="background:var(--panel);border:1px solid var(--border);padding:12px;border-radius:3px">
          <canvas id="usage-canvas" width="220" height="80"></canvas>
        </div>

        <div class="sidebar-label" style="margin-top:16px">Model Performance</div>
        <div style="background:var(--panel);border:1px solid var(--border);padding:12px;border-radius:3px;font-family:'JetBrains Mono',monospace;font-size:0.65rem;color:var(--text-dim);line-height:1.9">
          <div>Avg. latency: <span id="stat-latency" style="color:var(--mint)">‚Äî</span></div>
          <div>Fastest call: <span id="stat-fastest" style="color:var(--mint)">‚Äî</span></div>
          <div>Slowest call: <span id="stat-slowest" style="color:var(--amber)">‚Äî</span></div>
          <div>Total chars out: <span id="stat-chars" style="color:var(--text)">0</span></div>
        </div>
      </div>
    </div>
  </aside>

  <!-- STATUS BAR -->
  <footer id="statusbar">
    <div class="status-left">
      <div class="sb-item">
        <span style="opacity:0.5">‚óà</span>
        <span class="sb-accent">OpenMind OSS</span>
      </div>
      <div class="sb-item" id="sb-model">
        <span>model:</span>
        <span class="sb-warn">claude-sonnet-4.5</span>
      </div>
      <div class="sb-item" id="sb-session">
        <span>session:</span>
        <span>‚Äî</span>
      </div>
    </div>
    <div class="status-right">
      <div class="sb-item">
        <span id="sb-time"></span>
      </div>
      <div class="sb-item">
        <span>MIT License</span>
        <span style="opacity:0.4">¬∑</span>
        <a href="https://github.com" target="_blank" style="color:var(--text-dim);text-decoration:none">GitHub ‚Üó</a>
      </div>
    </div>
  </footer>

</div>

<script>
// ============================================================
// OPENMIND ‚Äî CORE APPLICATION
// ============================================================

// --- STATE ---
let apiKey = sessionStorage.getItem('om_apikey') || '';
let currentModel = 'claude-sonnet-4-5-20250929';
let sessions = JSON.parse(localStorage.getItem('om_sessions') || '[]');
let activeSession = null;
let isThinking = false;

const config = {
  temperature: 0.7,
  maxTokens: 2048,
  topP: 0.95,
  streaming: true,
  autoSave: true,
  responseFormat: 'markdown'
};

const globalStats = {
  totalMessages: 0,
  totalCalls: 0,
  totalCharsOut: 0,
  latencies: [],
};

const memories = JSON.parse(localStorage.getItem('om_memories') || '[]');

const plugins = [
  { id: 'web-search', name: 'Web Search', icon: 'üîç', desc: 'Search the web', enabled: false },
  { id: 'code-exec', name: 'Code Runner', icon: '‚ö°', desc: 'Execute snippets', enabled: true },
  { id: 'markdown', name: 'Markdown', icon: 'üìù', desc: 'Rich formatting', enabled: true },
  { id: 'memory', name: 'Auto-Memory', icon: 'üß†', desc: 'Remember context', enabled: false },
  { id: 'export', name: 'Export Tools', icon: 'üì§', desc: 'PDF/JSON export', enabled: true },
];

// --- INIT ---
function init() {
  renderSessions();
  renderPlugins();
  renderMemory();
  updateClock();
  setInterval(updateClock, 1000);
  updateStats();

  if (!apiKey) {
    document.getElementById('api-modal').classList.remove('hidden');
  } else {
    document.getElementById('api-modal').classList.add('hidden');
  }

  // Keyboard shortcuts
  document.addEventListener('keydown', e => {
    if (e.ctrlKey && e.key === 'k') { e.preventDefault(); newSession(); }
    if (e.ctrlKey && e.key === 'e') { e.preventDefault(); exportChat(); }
  });

  // Focus input
  document.getElementById('msg-input').focus();

  updateConvInfo();
}

// --- API KEY ---
function saveApiKey() {
  const key = document.getElementById('api-key-input').value.trim();
  if (!key.startsWith('sk-ant-')) {
    toast('Invalid API key format. Must start with sk-ant-', 'error');
    return;
  }
  apiKey = key;
  sessionStorage.setItem('om_apikey', key);
  document.getElementById('api-modal').classList.add('hidden');
  toast('API key saved. OpenMind is ready!', 'success');
  document.getElementById('msg-input').focus();
}

function skipApiKey() {
  apiKey = 'DEMO';
  document.getElementById('api-modal').classList.add('hidden');
  toast('Demo mode ‚Äî responses are simulated', 'info');
  document.getElementById('msg-input').focus();
}

function showApiModal() {
  document.getElementById('api-modal').classList.remove('hidden');
}

// --- MODEL SELECTION ---
function setModel(model, btn) {
  currentModel = model;
  document.querySelectorAll('.model-pill').forEach(p => p.classList.remove('active'));
  btn.classList.add('active');

  const names = {
    'claude-sonnet-4-5-20250929': 'claude-sonnet-4.5',
    'claude-haiku-4-5-20251001': 'claude-haiku-4.5',
    'claude-opus-4-5-20251101': 'claude-opus-4.5'
  };
  document.getElementById('sb-model').innerHTML = `<span>model:</span><span class="sb-warn">${names[model]}</span>`;
  document.getElementById('info-model').textContent = names[model];
  toast(`Model: ${names[model]}`, 'info');
}

// --- SESSIONS ---
function newSession() {
  const id = 'sess_' + Date.now();
  const session = {
    id, title: 'New Conversation',
    createdAt: Date.now(),
    messages: [],
    systemPrompt: document.getElementById('sys-prompt').value
  };
  sessions.unshift(session);
  activeSession = session;
  saveSessions();
  renderSessions();
  clearMessages();
  updateConvInfo();
  document.getElementById('info-session').textContent = id.slice(-6);
  document.getElementById('sb-session').innerHTML = `<span>session:</span><span>${id.slice(-6)}</span>`;
  toast('New session started', 'success');
  document.getElementById('msg-input').focus();
}

function loadSession(id) {
  const sess = sessions.find(s => s.id === id);
  if (!sess) return;
  activeSession = sess;
  clearMessages(true);

  sess.messages.forEach(m => {
    appendMessage(m.role, m.content, m.timestamp, false);
  });

  renderSessions();
  updateConvInfo();
  document.getElementById('info-session').textContent = id.slice(-6);
  document.getElementById('sb-session').innerHTML = `<span>session:</span><span>${id.slice(-6)}</span>`;
}

function clearMessages(keepWelcome = false) {
  const msgs = document.getElementById('messages');
  msgs.innerHTML = '';
  if (!keepWelcome || !activeSession || activeSession.messages.length === 0) {
    msgs.innerHTML = `<div id="welcome">
      <div class="welcome-orb">
        <div class="orb-ring"></div><div class="orb-ring"></div><div class="orb-core"></div>
      </div>
      <div>
        <div class="welcome-title">Welcome to <span>OpenMind</span></div>
        <div class="welcome-sub" style="margin:8px auto 0">Start a conversation below.</div>
      </div>
      <div class="suggestions">
        <div class="suggestion" onclick="useSuggestion('Write me a Python script to scrape headlines from Hacker News and summarize them')">
          <span class="sug-icon">üêç</span><div class="sug-title">Code Generation</div><div class="sug-desc">Write Python scripts & more</div>
        </div>
        <div class="suggestion" onclick="useSuggestion('Explain quantum entanglement in simple terms with everyday analogies')">
          <span class="sug-icon">‚öõÔ∏è</span><div class="sug-title">Deep Explanation</div><div class="sug-desc">Break down complex topics</div>
        </div>
        <div class="suggestion" onclick="useSuggestion('Help me write a compelling product pitch for a new app idea')">
          <span class="sug-icon">üöÄ</span><div class="sug-title">Brainstorm & Create</div><div class="sug-desc">Ideas and strategic thinking</div>
        </div>
        <div class="suggestion" onclick="useSuggestion('Review this SQL query for performance issues: SELECT * FROM orders WHERE date > 2024-01-01')">
          <span class="sug-icon">üóÑÔ∏è</span><div class="sug-title">Query Optimizer</div><div class="sug-desc">SQL & database help</div>
        </div>
      </div>
    </div>`;
  }
}

function saveSessions() {
  if (config.autoSave) {
    localStorage.setItem('om_sessions', JSON.stringify(sessions.slice(0, 50)));
  }
}

function renderSessions() {
  const list = document.getElementById('sessions-list');
  list.innerHTML = '';
  sessions.forEach(sess => {
    const el = document.createElement('div');
    el.className = 'session-item' + (activeSession && activeSession.id === sess.id ? ' active' : '');
    const time = new Date(sess.createdAt).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
    const date = new Date(sess.createdAt).toLocaleDateString([], {month:'short',day:'numeric'});
    el.innerHTML = `
      <div class="session-title">${escHtml(sess.title)}</div>
      <div class="session-meta">${date} ¬∑ ${time} ¬∑ ${sess.messages.length} msgs</div>
    `;
    el.onclick = () => loadSession(sess.id);
    list.appendChild(el);
  });
  document.getElementById('stat-sessions').textContent = sessions.length;
  updateStats();
}

function clearAllSessions() {
  if (!confirm('Clear all sessions? This cannot be undone.')) return;
  sessions = [];
  activeSession = null;
  saveSessions();
  renderSessions();
  clearMessages();
  toast('All sessions cleared', 'info');
}

// --- PLUGINS ---
function renderPlugins() {
  const container = document.getElementById('plugins-section');
  container.innerHTML = '';
  plugins.forEach(p => {
    const el = document.createElement('div');
    el.className = 'plugin-card' + (p.enabled ? ' enabled' : '');
    el.innerHTML = `
      <span class="plugin-icon">${p.icon}</span>
      <div class="plugin-info">
        <div class="plugin-name">${p.name}</div>
        <div class="plugin-desc">${p.desc}</div>
      </div>
      <div class="plugin-toggle ${p.enabled ? 'on' : ''}" onclick="togglePlugin('${p.id}', event)"></div>
    `;
    container.appendChild(el);
  });
}

function togglePlugin(id, e) {
  e.stopPropagation();
  const p = plugins.find(x => x.id === id);
  if (!p) return;
  p.enabled = !p.enabled;
  renderPlugins();
  toast(`${p.name}: ${p.enabled ? 'enabled' : 'disabled'}`, 'info');
}

// --- MEMORY ---
function renderMemory() {
  const list = document.getElementById('memory-list');
  list.innerHTML = '';
  if (memories.length === 0) {
    list.innerHTML = '<div style="font-family:\'JetBrains Mono\',monospace;font-size:0.65rem;color:var(--text-dim);text-align:center;padding:24px">No memories yet.<br>Add facts below.</div>';
  }
  memories.forEach((m, i) => {
    const el = document.createElement('div');
    el.className = 'memory-item';
    el.innerHTML = `${escHtml(m)}<span class="memory-delete" onclick="deleteMemory(${i})">‚úï</span>`;
    list.appendChild(el);
  });
}

function addMemory() {
  const inp = document.getElementById('mem-input');
  const val = inp.value.trim();
  if (!val) return;
  memories.push(val);
  localStorage.setItem('om_memories', JSON.stringify(memories));
  inp.value = '';
  renderMemory();
  toast('Memory saved', 'success');
}

function deleteMemory(i) {
  memories.splice(i, 1);
  localStorage.setItem('om_memories', JSON.stringify(memories));
  renderMemory();
}

// --- SENDING MESSAGES ---
async function sendMessage() {
  const input = document.getElementById('msg-input');
  const text = input.value.trim();
  if (!text || isThinking) return;

  // Auto-create session
  if (!activeSession) {
    const id = 'sess_' + Date.now();
    activeSession = {
      id, title: text.slice(0, 40) + (text.length > 40 ? '‚Ä¶' : ''),
      createdAt: Date.now(),
      messages: [],
      systemPrompt: document.getElementById('sys-prompt').value
    };
    sessions.unshift(activeSession);
    document.getElementById('info-session').textContent = id.slice(-6);
    document.getElementById('sb-session').innerHTML = `<span>session:</span><span>${id.slice(-6)}</span>`;
  }

  // Remove welcome screen
  const welcome = document.getElementById('welcome');
  if (welcome) welcome.remove();

  input.value = '';
  autoResize(input);
  updateCharCount();

  // Add user message
  const userMsg = { role: 'user', content: text, timestamp: Date.now() };
  activeSession.messages.push(userMsg);
  appendMessage('user', text, userMsg.timestamp, true);

  // Update title from first message
  if (activeSession.messages.filter(m => m.role === 'user').length === 1) {
    activeSession.title = text.slice(0, 42) + (text.length > 42 ? '‚Ä¶' : '');
  }

  globalStats.totalMessages++;
  updateStats();
  updateConvInfo();

  // Set thinking state
  setThinking(true);
  const thinkEl = appendThinking();
  const callStart = Date.now();

  try {
    let response;
    if (apiKey === 'DEMO') {
      response = await demoResponse(text);
    } else {
      response = await callClaudeAPI();
    }

    thinkEl.remove();

    const aiMsg = { role: 'assistant', content: response, timestamp: Date.now() };
    activeSession.messages.push(aiMsg);
    appendMessage('assistant', response, aiMsg.timestamp, true);

    globalStats.totalCalls++;
    globalStats.totalCharsOut += response.length;
    const latency = Date.now() - callStart;
    globalStats.latencies.push(latency);

    updateLatencyStats(latency);
    updateStats();
    updateConvInfo();
    saveSessions();
    renderSessions();

  } catch (err) {
    thinkEl.remove();
    const errMsg = `**Error:** ${err.message}\n\nCheck your API key in the settings (üîë button in the toolbar).`;
    appendMessage('assistant', errMsg, Date.now(), true);
    toast(err.message, 'error');
  }

  setThinking(false);
}

// --- CLAUDE API CALL ---
async function callClaudeAPI() {
  const sysPrompt = document.getElementById('sys-prompt').value;
  const memCtx = memories.length > 0
    ? '\n\n[User memories: ' + memories.join('; ') + ']'
    : '';

  const messages = activeSession.messages
    .filter(m => m.role !== 'thinking')
    .map(m => ({ role: m.role, content: m.content }));

  const body = {
    model: currentModel,
    max_tokens: config.maxTokens,
    temperature: config.temperature,
    top_p: config.topP,
    system: sysPrompt + memCtx,
    messages
  };

  const res = await fetch('https://api.anthropic.com/v1/messages', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'x-api-key': apiKey,
      'anthropic-version': '2023-06-01',
      'anthropic-dangerous-direct-browser-access': 'true'
    },
    body: JSON.stringify(body)
  });

  if (!res.ok) {
    const err = await res.json().catch(() => ({}));
    throw new Error(err.error?.message || `API Error ${res.status}`);
  }

  const data = await res.json();
  return data.content[0]?.text || '*(empty response)*';
}

// --- DEMO RESPONSES ---
async function demoResponse(text) {
  await new Promise(r => setTimeout(r, 1200 + Math.random() * 1000));
  const responses = [
    `# OpenMind Demo Mode\n\nThis is a **simulated response** ‚Äî you're running in demo mode without an API key.\n\nTo get real responses:\n1. Get your API key from [console.anthropic.com](https://console.anthropic.com)\n2. Click the üîë button in the toolbar\n3. Enter your key\n\nYou asked: *"${text}"*\n\n---\nOpenMind is fully open source under the MIT license. All conversation history is stored locally in your browser.`,
    `Here's what I'd tell you about **"${text.slice(0,50)}..."**:\n\nIn demo mode, I can show you the interface but not process real queries. The chat layout, sessions, memory system, and plugin framework are all functional ‚Äî just connect your API key to unlock full Claude AI capabilities.\n\n\`\`\`python\n# Example code block rendering\ndef hello_openmind():\n    print("Connect your API key!")\n\nhello_openmind()\n\`\`\`\n\nThe code renderer above is live ‚Äî syntax highlighting works in real conversations too.`,
    `**Demo Response** for: *${text.slice(0,60)}*\n\nOpenMind features:\n- üîë Local API key storage (never sent to our servers)\n- üìÅ Session history (persisted in localStorage)\n- üß† Memory system for user facts\n- ‚ö° Plugin architecture\n- üìä Usage statistics\n- ‚öôÔ∏è Model configuration (temperature, max tokens, etc.)\n\nAll open source under **MIT License** ‚Äî fork, modify, and deploy anywhere.`
  ];
  return responses[Math.floor(Math.random() * responses.length)];
}

// --- MESSAGE RENDERING ---
function appendMessage(role, content, timestamp, scroll = true) {
  const el = document.createElement('div');
  el.className = `message ${role === 'user' ? 'user' : 'ai'}`;

  const time = new Date(timestamp).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
  const shortModel = currentModel.includes('haiku') ? 'HAI' : currentModel.includes('opus') ? 'OPS' : 'SON';

  el.innerHTML = `
    <div class="msg-avatar ${role === 'user' ? 'user-av' : 'ai'}">${role === 'user' ? 'YOU' : 'AI'}</div>
    <div class="msg-content">
      <div class="msg-meta">
        <span class="msg-role">${role === 'user' ? 'You' : 'OpenMind'}</span>
        <span class="msg-time">${time}</span>
        ${role !== 'user' ? `<span class="msg-model-tag">${shortModel}</span>` : ''}
      </div>
      <div class="msg-bubble">${renderContent(content)}</div>
      <div class="msg-actions">
        <button class="msg-action" onclick="copyMsg(this)">Copy</button>
        ${role !== 'user' ? '<button class="msg-action" onclick="regenMsg(this)">Regen</button>' : ''}
        <button class="msg-action" onclick="deleteMsg(this)">Delete</button>
      </div>
    </div>
  `;

  const messages = document.getElementById('messages');
  messages.appendChild(el);
  if (scroll) messages.scrollTop = messages.scrollHeight;
  return el;
}

function appendThinking() {
  const el = document.createElement('div');
  el.className = 'message ai thinking-msg';
  el.innerHTML = `
    <div class="msg-avatar ai">AI</div>
    <div class="msg-content">
      <div class="msg-meta"><span class="msg-role">OpenMind</span></div>
      <div class="msg-bubble">
        <div class="think-dots">
          <span></span><span></span><span></span>
        </div>
        <span>Thinking‚Ä¶</span>
      </div>
    </div>
  `;
  const messages = document.getElementById('messages');
  messages.appendChild(el);
  messages.scrollTop = messages.scrollHeight;
  return el;
}

function renderContent(content) {
  // Basic markdown rendering
  let html = escHtml(content);

  // Code blocks (``` ```)
  html = html.replace(/```(\w*)\n?([\s\S]*?)```/g, (_, lang, code) =>
    `<pre><code>${code.trim()}</code></pre>`
  );

  // Inline code
  html = html.replace(/`([^`]+)`/g, '<code>$1</code>');

  // Bold
  html = html.replace(/\*\*([^*]+)\*\*/g, '<strong style="color:var(--text-bright)">$1</strong>');

  // Italic
  html = html.replace(/\*([^*]+)\*/g, '<em style="color:var(--text-dim)">$1</em>');

  // Headers
  html = html.replace(/^# (.+)$/gm, '<div style="font-size:1.05rem;font-weight:700;color:var(--text-bright);margin:8px 0 4px">$1</div>');
  html = html.replace(/^## (.+)$/gm, '<div style="font-size:0.95rem;font-weight:700;color:var(--amber);margin:6px 0 3px">$1</div>');
  html = html.replace(/^### (.+)$/gm, '<div style="font-size:0.88rem;font-weight:700;color:var(--mint);margin:4px 0 2px">$1</div>');

  // Horizontal rule
  html = html.replace(/^---$/gm, '<hr style="border:none;border-top:1px solid var(--border);margin:10px 0">');

  // Links
  html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" style="color:var(--amber);text-decoration:underline">$1</a>');

  // Lists
  html = html.replace(/^\d+\. (.+)$/gm, '<div style="margin:3px 0;padding-left:16px;color:var(--text)">‚Ä¢ $1</div>');
  html = html.replace(/^- (.+)$/gm, '<div style="margin:2px 0;padding-left:12px;color:var(--text)">‚ó¶ $1</div>');

  // Newlines
  html = html.replace(/\n\n/g, '<br><br>');
  html = html.replace(/\n/g, '<br>');

  return html;
}

// --- MESSAGE ACTIONS ---
function copyMsg(btn) {
  const bubble = btn.closest('.msg-content').querySelector('.msg-bubble');
  navigator.clipboard.writeText(bubble.innerText).then(() => toast('Copied!', 'success'));
}

function deleteMsg(btn) {
  btn.closest('.message').remove();
  toast('Message deleted', 'info');
}

function regenMsg(btn) {
  if (!activeSession || activeSession.messages.length < 2) return;
  // Remove last assistant message and resend
  const msgs = activeSession.messages;
  const lastAiIdx = msgs.map(m => m.role).lastIndexOf('assistant');
  if (lastAiIdx === -1) return;
  activeSession.messages.splice(lastAiIdx, 1);
  btn.closest('.message').remove();
  // Resend
  const lastUser = [...msgs].reverse().find(m => m.role === 'user');
  if (lastUser) {
    document.getElementById('msg-input').value = '';
    setThinking(true);
    const thinkEl = appendThinking();
    (apiKey === 'DEMO' ? demoResponse(lastUser.content) : callClaudeAPI())
      .then(r => {
        thinkEl.remove();
        const aiMsg = { role: 'assistant', content: r, timestamp: Date.now() };
        activeSession.messages.push(aiMsg);
        appendMessage('assistant', r, aiMsg.timestamp, true);
        setThinking(false);
        saveSessions();
      })
      .catch(e => { thinkEl.remove(); setThinking(false); toast(e.message,'error'); });
  }
}

// --- UI HELPERS ---
function setThinking(val) {
  isThinking = val;
  const dot = document.getElementById('status-dot');
  const txt = document.getElementById('status-text');
  const btn = document.getElementById('send-btn');
  dot.className = 'status-dot' + (val ? ' thinking' : '');
  txt.textContent = val ? 'THINKING‚Ä¶' : 'READY';
  btn.disabled = val;
}

function handleKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
}

function autoResize(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 160) + 'px';
}

function updateCharCount() {
  const v = document.getElementById('msg-input').value.length;
  document.getElementById('char-count').textContent = `${v} chars`;
}

function useSuggestion(text) {
  const inp = document.getElementById('msg-input');
  inp.value = text;
  autoResize(inp);
  updateCharCount();
  inp.focus();
}

function openFileMenu() {
  toast('File attachment ‚Äî coming in v1.1!', 'info');
}

function switchRsbTab(tab, btn) {
  document.querySelectorAll('.rsb-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.rsb-panel').forEach(p => p.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById(`rsb-${tab}`).classList.add('active');
}

function updateSetting(key, val, displayId) {
  config[key] = parseFloat(val);
  document.getElementById(displayId).textContent = val;
}

function saveSystemPrompt() {
  if (activeSession) activeSession.systemPrompt = document.getElementById('sys-prompt').value;
}

function updateConvInfo() {
  if (!activeSession) {
    document.getElementById('info-msgs').textContent = '0';
    document.getElementById('info-tokens').textContent = '0';
    return;
  }
  const msgs = activeSession.messages.length;
  const chars = activeSession.messages.reduce((a, m) => a + m.content.length, 0);
  const tokens = Math.round(chars / 4);
  document.getElementById('info-msgs').textContent = msgs;
  document.getElementById('info-tokens').textContent = tokens.toLocaleString();
  document.getElementById('stat-msgs').textContent = globalStats.totalMessages;
  document.getElementById('stat-tokens').textContent = tokens.toLocaleString();
  document.getElementById('stat-calls').textContent = globalStats.totalCalls;
}

function updateStats() {
  document.getElementById('stat-msgs').textContent = globalStats.totalMessages;
  document.getElementById('stat-calls').textContent = globalStats.totalCalls;
  document.getElementById('stat-chars').textContent = globalStats.totalCharsOut.toLocaleString();
  document.getElementById('stat-sessions').textContent = sessions.length;
  drawUsageChart();
}

function updateLatencyStats(latency) {
  const lats = globalStats.latencies;
  const avg = Math.round(lats.reduce((a,b)=>a+b,0)/lats.length);
  const min = Math.min(...lats);
  const max = Math.max(...lats);
  document.getElementById('stat-latency').textContent = avg + 'ms';
  document.getElementById('stat-fastest').textContent = min + 'ms';
  document.getElementById('stat-slowest').textContent = max + 'ms';
}

function drawUsageChart() {
  const canvas = document.getElementById('usage-canvas');
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0, 0, 220, 80);

  const data = sessions.slice(0, 10).map(s => s.messages.length).reverse();
  if (data.length === 0) return;

  const max = Math.max(...data, 1);
  const barW = 18, gap = 4;
  const startX = 10;

  data.forEach((v, i) => {
    const h = Math.max(2, (v / max) * 60);
    const x = startX + i * (barW + gap);
    const y = 70 - h;

    const grad = ctx.createLinearGradient(0, y, 0, 70);
    grad.addColorStop(0, '#f5a623');
    grad.addColorStop(1, 'rgba(245,166,35,0.2)');
    ctx.fillStyle = grad;
    ctx.fillRect(x, y, barW, h);
  });
}

function updateClock() {
  const now = new Date();
  document.getElementById('sb-time').textContent =
    now.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',second:'2-digit'});
}

function exportChat() {
  if (!activeSession || activeSession.messages.length === 0) {
    toast('No messages to export', 'info');
    return;
  }
  const data = {
    session: activeSession.title,
    model: currentModel,
    exportedAt: new Date().toISOString(),
    messages: activeSession.messages
  };
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `openmind-${Date.now()}.json`;
  a.click(); URL.revokeObjectURL(url);
  toast('Session exported as JSON', 'success');
}

function toast(msg, type = 'info') {
  const c = document.getElementById('toast-container');
  const t = document.createElement('div');
  t.className = `toast ${type}`;
  t.textContent = msg;
  c.appendChild(t);
  setTimeout(() => { t.style.opacity = '0'; t.style.transition = 'opacity 0.3s'; setTimeout(() => t.remove(), 300); }, 3000);
}

function escHtml(str) {
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// Allow enter on API key input
document.addEventListener('DOMContentLoaded', () => {
  const inp = document.getElementById('api-key-input');
  if (inp) inp.addEventListener('keydown', e => { if (e.key === 'Enter') saveApiKey(); });
  init();
});
</script>
</body>
</html>
